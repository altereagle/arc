<!DOCTYPE html>

<html>
<head>
  <title>Arc | Support</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="check_config.html">
                  support/check_config.js
                </a>
              
                
                <a class="source" href="create_api_server.html">
                  support/create_api_server.js
                </a>
              
                
                <a class="source" href="create_worker_pool.html">
                  support/create_worker_pool.js
                </a>
              
                
                <a class="source" href="message_parser.html">
                  support/message_parser.js
                </a>
              
                
                <a class="source" href="microservice_creator.html">
                  support/microservice_creator.js
                </a>
              
                
                <a class="source" href="protocol_event_setter.html">
                  support/protocol_event_setter.js
                </a>
              
                
                <a class="source" href="shutdown_microservices.html">
                  support/shutdown_microservices.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="arc-support">Arc | Support</h1>
<h3 id="create-microservice-worker-pool">Create Microservice Worker Pool</h3>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Arc loads a child process forker</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> { fork } = <span class="hljs-built_in">require</span>(<span class="hljs-string">`child_process`</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Arc loads dependencies required to create microservice pools</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> { <span class="hljs-string">'generic-pool'</span>: genericPool } = <span class="hljs-built_in">require</span>(<span class="hljs-string">`<span class="hljs-subst">${process.cwd()}</span>/dependencies`</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Arc creates a microservice worker pool</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">module</span>.exports = <span class="hljs-function">(<span class="hljs-params">{paperboy}</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">parseMessage, {title, config}</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h4 id="microservice-pool-configuration">Microservice Pool Configuration</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <ul>
<li>Arc gets the resource to use from the configuration</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      resource,</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <ul>
<li>Arc gets the max load from the configuration</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      maxLoad        = <span class="hljs-number">1</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <ul>
<li>Arc gets the resource folder to use from the configuration</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      resourceFolder = <span class="hljs-string">`microservice`</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <ul>
<li>Arc gets the initial process count from the configuration</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      count          = <span class="hljs-number">1</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <ul>
<li>Arc gets the initial starting state from the configuration</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      startOnline    = <span class="hljs-literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <ul>
<li>Arc gets the protocol to use from the configuration</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      protocol       = <span class="hljs-string">`unknown://`</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <ul>
<li>Arc gets the description from the configuration</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      description    = <span class="hljs-string">`describe what this does`</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <ul>
<li>Arc gets the settings to pass to the microservice pool from the configuration</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      settings
    } = config;

    <span class="hljs-keyword">return</span> genericPool.createPool({</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h4 id="microservice-creation">Microservice Creation</h4>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p><strong>Given</strong> a new microservice needs to be created to add to the pool</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      create: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p><strong>When</strong> Arc creates the microservice object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">const</span> microservice = {</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p><strong>And</strong> Arc adds the configurations to the object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          title, settings, resource, protocol, maxLoad,</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p><strong>And</strong> Arc forks a process for the microservice</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          process : fork(<span class="hljs-string">`<span class="hljs-subst">${process.cwd()}</span>/library/arc/support/process`</span>)
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p><strong>Then</strong> Arc triggers a health notification to indicate the microservice was created</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        paperboy.trigger(<span class="hljs-string">`@health`</span>, <span class="hljs-built_in">JSON</span>.stringify({
          <span class="hljs-attr">title</span>: title, <span class="hljs-attr">metrics</span>: {
            <span class="hljs-attr">status</span>: <span class="hljs-string">`created`</span>, resource, resourceFolder, protocol, description,
            <span class="hljs-attr">pid</span>: microservice.process.pid
          }, <span class="hljs-attr">pid</span>: process.pid}));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Arc sets local variables indicating the <code>resource</code> and <code>settings</code> have been set for the microservice</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">let</span> resourceSet = <span class="hljs-literal">false</span>;
          <span class="hljs-keyword">let</span> settingsSet = settings != <span class="hljs-literal">undefined</span> ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h4 id="microservice-setup">Microservice setup</h4>

            </div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Arc creates an event listener for microservice setup events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">const</span> setupListener = <span class="hljs-function">(<span class="hljs-params">message</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p><strong>Given</strong> Arc listens for setup oriented events indicating the <code>resource</code> and <code>settings</code> are set for the microservice</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span>(message === <span class="hljs-string">`*setup://title/work/set`</span>) resourceSet = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">if</span>(message === <span class="hljs-string">`*setup://settings/set`</span>)   settingsSet = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p><strong>When</strong> the setup listener is called and the resource and settings have been set for the microservice</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span>(resourceSet &amp;&amp; settingsSet) {</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p><strong>Then</strong> Arc will remove the setup listener</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              microservice.process.removeListener(<span class="hljs-string">`message`</span>, setupListener);</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p><strong>And</strong> Arc will trigger a health notification for the microservice</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              paperboy.trigger(<span class="hljs-string">`@health`</span>, <span class="hljs-built_in">JSON</span>.stringify({
                <span class="hljs-attr">title</span>: microservice.title,
                <span class="hljs-attr">metrics</span>: {
                  <span class="hljs-attr">message</span>: <span class="hljs-string">`online`</span>,
                  <span class="hljs-attr">pid</span>: microservice.process.pid
                }, <span class="hljs-attr">pid</span>: process.pid}));</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p><strong>And</strong> Arc will add the <code>message</code> event listener for the microservice</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              microservice.process.on(<span class="hljs-string">`message`</span>, (message) =&gt; {
                parseMessage({microservice, message});
              });</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p><strong>And</strong> Arc will return the microservice</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              resolve(microservice);
            }
          };</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <h4 id="the-microservices-are-setup-by-sending-data-to-the-process">The microservices are setup by sending data to the process</h4>

            </div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Arc adds an event listener that listens for microservice setup events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          microservice.process.on(<span class="hljs-string">`message`</span>, setupListener);</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Arc sends the title, resource, and resource folder to the microservice</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          microservice.process.send(<span class="hljs-string">`*setup://<span class="hljs-subst">${title}</span>//<span class="hljs-subst">${resource}</span>//<span class="hljs-subst">${resourceFolder}</span>`</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Arc sends the settings to the microservice</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span>(settings) microservice.process.send(<span class="hljs-string">`*settings://<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(settings)}</span>`</span>);
        });
      },</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <h4 id="the-microservice-pool-kills-processes-that-are-destroyed">The microservice pool kills processes that are destroyed</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>      destroy: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">microservice</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p><strong>TODO:</strong> remove protocol events for destroyed processes from paperboy</p>

            </div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Arc kills processes that are destroyed by the pool</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        microservice.process.kill();</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Arc triggers a health notification for the killed microservice process</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        paperboy.trigger(<span class="hljs-string">`@health`</span>, <span class="hljs-built_in">JSON</span>.stringify({
          <span class="hljs-attr">title</span>: microservice.title,
          <span class="hljs-attr">metrics</span>: {
            <span class="hljs-attr">destroyed</span>: microservice.process.pid
          }, <span class="hljs-attr">pid</span>: process.pid}));</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Arc returns the microservice with a killed process</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve(microservice);
      },
    }, {</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Arc sets the minimum number of microservice processes available in the pool</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      min      : startOnline ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Arc sets the maximum number of microservices in the pool</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      max      : count,</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Arc will start the microservice process immediately by default</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      autostart: startOnline ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>
    });
  };
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
